#!/usr/bin/with-contenv bash
# shellcheck shell=bash

exec 1> >(tee -a /config/code-server.log)
exec 2> >(tee -a /config/code-server.log >&2)

echo "[$(date)] Starting code-server service"

if [[ -n "${PASSWORD}" ]] || [[ -n "${HASHED_PASSWORD}" ]]; then
    AUTH="password"
    echo "[$(date)] Authentication mode: password"
else
    AUTH="none"
    echo "[$(date)] Starting with no password"
fi

if [[ -z ${PROXY_DOMAIN+x} ]]; then
    PROXY_DOMAIN_ARG=""
    echo "[$(date)] No proxy domain configured"
else
    PROXY_DOMAIN_ARG="--proxy-domain=${PROXY_DOMAIN}"
    echo "[$(date)] Using proxy domain: ${PROXY_DOMAIN}"
fi

echo "[$(date)] Checking directory permissions..."
ls -la /config/
echo "[$(date)] Checking workspace directory..."
ls -la /workspace/

echo "[$(date)] Starting code-server with following configuration:"
echo "- Bind address: 0.0.0.0:8443"
echo "- User data dir: /config/data"
echo "- Extensions dir: /config/extensions"
echo "- Auth mode: ${AUTH}"
echo "- Proxy domain arg: ${PROXY_DOMAIN_ARG}"
echo "- Default workspace: ${DEFAULT_WORKSPACE:-/config/workspace}"

exec \
    s6-notifyoncheck -d -n 300 -w 1000 -c "nc -z 127.0.0.1 8443" \
        s6-setuidgid abc \
            /app/code-server/bin/code-server \
                --bind-addr 0.0.0.0:8443 \
                --user-data-dir /config/data \
                --extensions-dir /config/extensions \
                --disable-telemetry \
                --auth "${AUTH}" \
                "${PROXY_DOMAIN_ARG}" \
                "${DEFAULT_WORKSPACE:-/config/workspace}"
